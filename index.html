<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ChatTBD — Avatar Personas</title>
  <style>
  @media (max-width: 900px) {
    .heroInput {
      width: min(400.69px, calc(56vw - 32px));
    }
  }
    @keyframes blink-opacity {
      0% { opacity: 1; }
      50% { opacity: 0.3; }
      100% { opacity: 1; }
    }
    @media (max-width: 600px) {
      #persona::placeholder {
        content: "Create avatar...";
      }
    }
    :root{
      --bg:#000;
      --ink:#fff;
      --muted:#d9d9d9;
      --bubble:#333;
      --stroke:#fff;
      --radius-lg:24px;
      --radius-md:14px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; background:var(--bg); color:var(--ink); font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial}

    .screen{min-height:100vh; width:100%;}

    /* ===== Landing ===== */
  .landing{display:flex; align-items:center; justify-content:center; min-height:100vh; padding:25.6px}
  .heroRow{display:flex; align-items:center; gap:11.2px}
  .heroInput{display:flex; align-items:center; width:min(715.52px,calc(70vw - 32px)); border:1px solid var(--stroke); border-radius:800px; padding:11.2px 14.4px; background:transparent}
  .heroInput input{flex:1; background:transparent; border:0; outline:none; color:var(--ink); font-size:21.6px; line-height:1; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; width:0; min-width:0;}
    .heroInput input::placeholder { color:#fff; opacity:1; }
  .circleBtn{width:46.4px; height:46.4px; border-radius:999px; border:1px solid var(--stroke); background:transparent; display:grid; place-items:center; cursor:pointer}
  .circleBtn svg{width:33.6px; height:33.6px; fill:var(--ink)}

    /* ===== Chat ===== */
    .chat{position:relative; padding:32px 22px 96px; max-width:1200px; margin:0 auto}

    .backBtn{position:fixed; top:22px; left:22px; z-index:4}
  .backBtn .circleBtn{width:50px; height:50px; background:#000;}
    .backBtn .circleBtn svg { margin-left: -6px; }

    .column{display:flex; flex-direction:column; align-items:center; gap:18px;}

    .avatarFrame{width:333px; height:333px; border-radius:24px; overflow:hidden; border:1px solid var(--stroke); background:#1c1c1c; display:grid; place-items:center; margin-bottom:0;}

    .pane{position:relative; width:100%; max-width:760px;}
    .scroller{max-height:300px; overflow:auto; padding:0 0 0 0}
    .scroller::-webkit-scrollbar{width:12px}
    .scroller::-webkit-scrollbar-track{background:transparent}
    .scroller::-webkit-scrollbar-thumb{background:var(--stroke); border-radius:999px}

    .row{display:flex; margin:12px 0}
    .bubble{max-width:520px; background:var(--bubble); color:var(--muted); border-radius:18px; padding:14px 18px; font-size:14px; line-height:1.3; border:2px solid #2a2a2a}
    .bubble.from-bot{border:none; background:none;}
    .bubble.from-me{border:1px solid #fff; background:rgba(0,0,0,0.4); margin-right:10px;}
    .from-me{margin-left:auto; border-top-right-radius:8px}
    .from-bot{margin-right:auto; border-top-left-radius:8px}

  .composerWrap{position:fixed; left:50%; transform:translateX(-50%); bottom:20.8px; width:min(735.36px, 88.32vw); display:flex; align-items:center; gap:11.2px; z-index:3}
  .composer{flex:1; border:1px solid var(--stroke); border-radius:800px; padding:11.2px 14.4px; display:flex; align-items:center; gap:8px; background:#000; max-height:56px; overflow-y:auto;}
  .composer input{flex:1; background:transparent; border:0; outline:none; color:var(--ink); font-size:17.6px}
    .composer input::placeholder { color:#fff; opacity:1; }
  .sendBtn .circleBtn{width:40px; height:40px}

  .avatar-set-bubble {
    border: none !important;
    background: transparent !important;
    color: #fff !important;
    text-align: center !important;
    font-size: 18px !important;
    font-weight: 600 !important;
    width: fit-content !important;
    margin: 24px auto !important;
    left: 0 !important;
    right: 0 !important;
    padding: 0 20px !important;
  }

    .hide{display:none}

    .title {
      font-size: 48px;
      font-weight: 650;
      color: var(--ink);
      margin-bottom: 32px;
      letter-spacing: -0.02em;
    }
  </style>
</head>
<body>

  <!-- ===== Landing ===== -->
  <section id="landing" class="screen landing">
  <div style="position:relative; width:100%; display:flex; flex-direction:column; align-items:center;">
    <h1 class="title">ChatTBD</h1>
    <div id="safetyMsg" style="display:none; color:#ff5252; position:absolute; top:-32px; left:50%; transform:translateX(-50%); text-align:center; font-weight:500; pointer-events:none; z-index:10; width:max-content; max-width:90vw;"></div>
    <div class="heroRow">
      <label class="heroInput" aria-label="Persona prompt">
        <input id="persona" type="text" placeholder="Enter a prompt to create an avatar…" data-short-placeholder="Create avatar..." />
      </label>
      <button id="startBtn" class="circleBtn" title="Generate persona">
        <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
      </button>
    </div>
  </div>
  </section>

  <!-- ===== Chat ===== -->
  <section id="chat" class="screen chat hide">
    <div class="backBtn">
      <button id="back" class="circleBtn" title="Back">
        <svg viewBox="0 0 24 24"><path d="M15.41 7.41 14 6l-6 6 6 6 1.41-1.41L10.83 12z"/></svg>
      </button>
    </div>

    <div class="column">
      <!-- Avatar top -->
      <div id="avatar" class="avatarFrame"></div>
      <!-- Conversation pane -->
      <div class="pane" style="position:relative;">
        <div id="log" class="scroller" role="log" aria-live="polite"></div>
      </div>
    </div>

    <!-- Bottom composer -->
    <div class="composerWrap">
      <label class="composer">
        <input id="ask" type="text" placeholder="Ask anything" />
      </label>
      <button id="send" class="circleBtn sendBtn" title="Send">
        <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
      </button>
        </svg>
      </button>
    </div>
  </section>

  <script>
    const $ = s=>document.querySelector(s);
    const landing=$('#landing'), chat=$('#chat'), persona=$('#persona'),
          startBtn=$('#startBtn'), back=$('#back'), avatar=$('#avatar'),
          log=$('#log'), ask=$('#ask'), send=$('#send');

    // simple in-memory history for persona context
    const convo = [];

    // Handle responsive placeholder text
    function updatePlaceholder() {
      const input = document.getElementById('persona');
      if (window.innerWidth <= 600) {
        input.placeholder = input.dataset.shortPlaceholder;
      } else {
        input.placeholder = "Enter a prompt to create an avatar…";
      }
    }
    window.addEventListener('resize', updatePlaceholder);
    updatePlaceholder();

    persona.addEventListener('keydown', e=>{ if(e.key==='Enter') start(); });
    startBtn.addEventListener('click', start);
    back.addEventListener('click', ()=>{
      chat.classList.add('hide');
      landing.classList.remove('hide');
      persona.focus();
      // Clear chat when going back to landing
      log.innerHTML = '';
      convo.length = 0;
    });
    ask.addEventListener('keydown', e=>{ if(e.key==='Enter') doSend(); });
    send.addEventListener('click', doSend);

    async function start(){
      const p = persona.value.trim(); if(!p) return;

      landing.classList.add('hide');
      chat.classList.remove('hide');

      // ===== Generate avatar via API =====
      avatar.innerHTML = loader();
      try {
        const res = await fetch('/api/generate-avatar', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ prompt: p })
        });

        const json = await res.json().catch(() => ({}));
        if (!res.ok || !json?.dataUrl) {
          console.error('Avatar API error:', json);
          // Show landing, hide chat, and show error message above heroRow
          chat.classList.add('hide');
          landing.classList.remove('hide');
          let msg = document.getElementById('safetyMsg');
          if (msg) {
            msg.textContent = 'Content blocked by safety system. Avoid copyrighted, controversial, or explicit characters!';
            msg.style.display = 'block';
            // Hide after 3 seconds
            setTimeout(() => { msg.style.display = 'none'; }, 6000);
          }
          persona.focus();
          return;
        }

        // Remove safety message if present
        let msg = document.getElementById('safetyMsg');
        if (msg) msg.remove();

        avatar.innerHTML =
          `<img src="${json.dataUrl}" alt="Avatar" style="width:100%;height:100%;object-fit:cover;border-radius:24px;">`;
      } catch (err) {
        console.error('Avatar load failed:', err);
        avatar.innerHTML = fallbackAvatar();
        add('from-bot', 'Image generation failed. Using a placeholder.');
      }

      // reset chat UI
      log.innerHTML = '';
      convo.length = 0;
      add('from-bot', 'Avatar set: ' + p);
    }

    function loader(){
  return `<div style="width:100%;height:100%;display:grid;place-items:center;color:#fff;font-size:14px;"><span style='animation:blink-opacity 3s infinite;'>Generating...</span></div>`;
    }
    function fallbackAvatar(){
      return `<img src="https://upload.wikimedia.org/wikipedia/commons/7/7c/Profile_avatar_placeholder_large.png"
                 alt="Avatar Placeholder"
                 style="width:100%;height:100%;object-fit:cover;border-radius:24px;">`;
    }

    function add(who,text){
      const row = document.createElement('div'); row.className = 'row';
      const b = document.createElement('div');
      // If the message is the 'Avatar set:' message, add a special class for styling
      if (who === 'from-bot' && typeof text === 'string' && text.startsWith('Avatar set:')) {
        b.className = 'bubble from-bot avatar-set-bubble';
      } else {
        b.className = 'bubble ' + who;
      }
      b.textContent = text;
      row.appendChild(b); log.appendChild(row);
      setTimeout(()=>{ log.scrollTop = log.scrollHeight; }, 0);
    }

    async function doSend(){
      const t = ask.value.trim(); if(!t) return;
      ask.value=''; add('from-me',t);
      convo.push({ role:'user', content:t });

      try {
        const res = await fetch('/api/chat', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify({ persona: persona.value.trim(), message: t, history: convo })
        });
        const { text, error } = await res.json();
        if (error || !text) throw new Error(error || 'No response');
        add('from-bot', text);
        convo.push({ role:'assistant', content:text });
      } catch (err) {
        console.error('Chat error:', err);
        add('from-bot', 'Chat failed. Try again.');
      }
    }
  </script>
</body>
</html>
